<div class="container">
  <div id="spinner" *ngIf="cargando">
    <mat-spinner></mat-spinner>
  </div>
  <form>
    <mat-form-field class="input-autocomplete">
      <mat-label>especialidad o nombre</mat-label>
      <input
        type="text"
        placeholder="Escriba una especialidad o especialista"
        aria-label="text"
        matInput
        [formControl]="frmFiltro"
      />
    </mat-form-field>
  </form>

  <h2>Turnos</h2>
  <table
    mat-table
    [dataSource]="filteredOptions"
    class="mat-elevation-z8 demo-table tabla"
  >
    <ng-container matColumnDef="especialidad">
      <th mat-header-cell *matHeaderCellDef>especialidad</th>
      <td mat-cell *matCellDef="let element">{{ element.especialidad }}</td>
    </ng-container>
    <ng-container matColumnDef="fecha">
      <th mat-header-cell *matHeaderCellDef>fecha</th>
      <td mat-cell *matCellDef="let element">{{ element.fecha | date }}</td>
    </ng-container>
    <ng-container matColumnDef="horario">
      <th mat-header-cell *matHeaderCellDef>horario</th>
      <td mat-cell *matCellDef="let element">{{ element.horario }}</td>
    </ng-container>
    <ng-container matColumnDef="medico">
      <th mat-header-cell *matHeaderCellDef>medico</th>
      <td mat-cell *matCellDef="let element">{{ element.especialista }}</td>
    </ng-container>
    <ng-container matColumnDef="paciente">
      <th mat-header-cell *matHeaderCellDef>paciente</th>
      <td mat-cell *matCellDef="let element">{{ element.paciente }}</td>
    </ng-container>
    <ng-container matColumnDef="estado">
      <th mat-header-cell *matHeaderCellDef>estado</th>
      <td mat-cell *matCellDef="let element">{{ element.estado }}</td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="columnsTurnoPendientes"></tr>
    <tr mat-row *matRowDef="let row; columns: columnsTurnoPendientes" (click)="rowClicked(row)"></tr>
  </table>
  
  @if (turno) {
      <mat-card class="card" #card>
        @if (persona.tipoUsuario == 'especialista') {
            @if (turno.estado == 'pendiente') {
              <div class="buttons">
                  <button mat-fab color="warn" (click)="handleTurno('rechazado')" matTooltip="rechazar turno">
                  <mat-icon>cancel</mat-icon>
                  </button>
                  <button mat-fab color="primary" (click)="actualizarTurno(turno, 'aceptado')" matTooltip="aceptar turno">
                  <mat-icon>check_circle</mat-icon>
                  </button>
              </div>
          }@else if(turno.estado == 'aceptado'){
              <div class="buttons">
                  <button mat-fab color="warn" (click)="handleTurno('cancelado')" matTooltip="cancelar turno">
                  <mat-icon>cancel</mat-icon>
                  </button>
                  <button mat-fab color="primary" (click)="handleTurno('finalizado')" matTooltip="finalizar turno">
                      <mat-icon>verified</mat-icon>
                  </button>
              </div>
          }
          @if(quiereCancelar || quiereFinalizar){
              <mat-card-header> 
                  @if(quiereCancelar){
                      Por que desea cancelar el turno?
                  }@else{
                      Deje su diagnostico
                  }
              </mat-card-header>    
              <mat-form-field class="comentario">
                
                <mat-label>Debe dejarle un comentario a {{turno.paciente}}</mat-label>
                <textarea matInput placeholder="Dejanos un comentario" [(ngModel)]="comentario"></textarea>
              </mat-form-field>
              <mat-card-actions>
                  @if(quiereCancelar){
                      <button mat-stroked-button (click)="actualizarTurno(turno, 'cancelado')" [disabled]="comentario == ''">Cancelar turno</button>
                  }@else{
                      <button mat-stroked-button (click)="actualizarTurno(turno, 'finalizado')" [disabled]="comentario == ''">Confirmar turno</button>
                  }
              </mat-card-actions>
          }
          @if(turno.estado == "cancelado" || turno.estado == "rechazado" || turno.estado == 'finalizado'){
              <mat-card-header> 
                  @if(turno.estado == 'finalizado'){
                      Diagnistico
                  }@else{
                    @if (turno.comentarioPaciente != '') {
                      {{turno.paciente}} canceló por lo siguiente 
                    }@else {
                      {{turno.especialista}} canceló por lo siguiente   
                    }
                  }
              </mat-card-header>
              <mat-form-field class="comentario">
                @if (turno.comentarioPaciente != '') {
                    <mat-label>Comentario de {{turno.paciente}}</mat-label>
                    <textarea matInput placeholder="Dejanos un comentario" [(ngModel)]="turno.comentarioPaciente" disabled="true">
                    </textarea>
                  }@else {
                    <mat-label>Comentario a {{turno.paciente}}</mat-label>
                    <textarea matInput placeholder="Dejanos un comentario" [(ngModel)]="turno.comentarioEspecialista" disabled="true"></textarea>
                  }
              </mat-form-field>
          }
        }@else {
          @if(turno.estado == 'aceptado'){
            <div class="buttons">
                <button mat-fab color="warn" (click)="handleTurno('cancelado')" matTooltip="cancelar turno">
                <mat-icon>cancel</mat-icon>
                </button>
            </div>
        }
        @if(quiereCancelar){
            <mat-card-header> Por que desea cancelar el turno? </mat-card-header>    
            <mat-form-field class="comentario">
              <mat-label>Debe dejarle un comentario a {{turno.especialista}}</mat-label>
              <textarea matInput placeholder="Dejanos un comentario" [(ngModel)]="comentario"></textarea>
            </mat-form-field>
            <mat-card-actions>
              <button mat-stroked-button (click)="actualizarTurno(turno, 'cancelado')" [disabled]="comentario == ''">Cancelar turno</button>
            </mat-card-actions>
        }
        @if(turno.estado == "cancelado" || turno.estado == "rechazado" || turno.estado == 'finalizado'){
            <mat-card-header> 
                  @if(turno.estado == 'finalizado'){
                      Diagnistico
                  }@else{
                    @if (turno.comentarioPaciente != '') {
                      {{turno.paciente}} canceló por lo siguiente 
                    }@else {
                      {{turno.especialista}} canceló por lo siguiente   
                    }
                  }
            </mat-card-header>
            <mat-form-field class="comentario">
              @if (turno.comentarioEspecialista != '') {
                  <mat-label>Comentario de {{turno.especialista}}</mat-label>
                  <textarea matInput placeholder="Dejanos un comentario" [(ngModel)]="turno.comentarioEspecialista" disabled="true">
                  </textarea>
                }@else {
                  <mat-label>Comentario a {{turno.especialista}}</mat-label>
                  <textarea matInput placeholder="Dejanos un comentario" [(ngModel)]="turno.comentarioPaciente" disabled="true"></textarea>
                }
            </mat-form-field>
        }
        }
      </mat-card>
      <mat-card class="card">
        <form [formGroup]="frmEncuesta" (ngSubmit)="subirEncuesta()">
          @if (turno?.estado == 'finalizado') {
            <mat-card-header> 
              Formulario de satisfacción
            </mat-card-header>
            
            <!-- turno -->
            <!-- paciente -->
            <!-- especialista -->
            <!-- satisfaccion -->
            <!-- comentario -->
            <mat-form-field class="comentario" formControlName="satisfaccion">
            </mat-form-field>
          }
        </form>
      </mat-card>
    }

</div>